name: CI Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: '3.11'

jobs:
  lint-and-format:
    name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest

    steps:
    - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install black flake8 mypy isort
        pip install -r requirements.txt

    - name: Black ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬
      run: |
        black --check --diff src tests

    - name: isort import ì •ë ¬ ê²€ì‚¬
      run: |
        isort --check-only --diff src tests

    - name: Flake8 ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬
      run: |
        flake8 src tests --max-line-length=88 --extend-ignore=E203,W503

    - name: MyPy íƒ€ìž… ê²€ì‚¬
      run: |
        mypy src --ignore-missing-imports

  test:
    name: í…ŒìŠ¤íŠ¸ ì‹¤í–‰
    runs-on: ubuntu-latest
    needs: lint-and-format
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']

    steps:
    - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python ${{ matrix.python-version }} í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
        cache: 'pip'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-cov pytest-mock

    - name: ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        pytest tests/ -v --cov=src --cov-report=xml --cov-report=term-missing

    - name: ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ì—…ë¡œë“œ
      uses: codecov/codecov-action@v3
      if: matrix.python-version == '3.11'
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  model-test:
    name: ëª¨ë¸ í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: lint-and-format

    steps:
    - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ì„¤ì • íŒŒì¼ í™•ì¸
      run: |
        if [ ! -f configs/config.yaml ]; then
          echo "ì„¤ì • íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì • íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
          mkdir -p configs
          cat > configs/config.yaml << EOF
        data:
          raw_data_path: "data/raw"
          processed_data_path: "data/processed"
          image_size: [224, 224]
          batch_size: 32

        model:
          input_shape: [224, 224, 1]
          num_classes: 9
          learning_rate: 0.001
          early_stopping_patience: 10
          reduce_lr_patience: 5

        training:
          checkpoint_dir: "checkpoints"
          save_best_only: true

        classes:
          - "Center"
          - "Donut"
          - "Edge-Loc"
          - "Edge-Ring"
          - "Loc"
          - "Near-full"
          - "None"
          - "Random"
          - "Scratch"
        EOF
        fi

    - name: ëª¨ë¸ ìƒì„± í…ŒìŠ¤íŠ¸
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from models.cnn_model import DefectDetectionCNN
        print('ðŸ—ï¸ CNN ëª¨ë¸ ìƒì„± í…ŒìŠ¤íŠ¸ ì‹œìž‘')
        cnn = DefectDetectionCNN()
        model = cnn.build_model()
        print(f'âœ… ëª¨ë¸ ìƒì„± ì„±ê³µ! íŒŒë¼ë¯¸í„° ìˆ˜: {model.count_params():,}')
        print('ðŸ“‹ ëª¨ë¸ ìš”ì•½:')
        model.summary()
        "

    - name: ë°ì´í„° ë§¤ë‹ˆì € í…ŒìŠ¤íŠ¸
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from data.data_manager import DataManager
        print('ðŸ“Š ë°ì´í„° ë§¤ë‹ˆì € í…ŒìŠ¤íŠ¸ ì‹œìž‘')
        dm = DataManager()
        print('âœ… ë°ì´í„° ë§¤ë‹ˆì € ì´ˆê¸°í™” ì„±ê³µ!')
        "

    - name: ì½œë°± ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸
      run: |
        python -c "
        import sys
        sys.path.insert(0, 'src')
        from models.cnn_model import DefectDetectionCNN
        print('ðŸ”„ ì½œë°± ì‹œìŠ¤í…œ í…ŒìŠ¤íŠ¸ ì‹œìž‘')
        cnn = DefectDetectionCNN()
        callbacks = cnn.prepare_callbacks()
        print(f'âœ… ì½œë°± ìƒì„± ì„±ê³µ! ì½œë°± ìˆ˜: {len(callbacks)}')
        for i, callback in enumerate(callbacks):
            print(f'  {i+1}. {callback.__class__.__name__}')
        "

  integration-test:
    name: í†µí•© í…ŒìŠ¤íŠ¸
    runs-on: ubuntu-latest
    needs: [test, model-test]
    if: github.event_name == 'pull_request'

    steps:
    - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}
        cache: 'pip'

    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt

    - name: ìƒ˜í”Œ ë°ì´í„° ìƒì„± ë° ë¯¸ë‹ˆ í›ˆë ¨ í…ŒìŠ¤íŠ¸
      run: |
        python -c "
        import sys, os
        sys.path.insert(0, 'src')

        # ì„¤ì • íŒŒì¼ ìƒì„±
        os.makedirs('configs', exist_ok=True)
        with open('configs/config.yaml', 'w') as f:
            f.write('''
        data:
          raw_data_path: \"data/raw\"
          processed_data_path: \"data/processed\"
          image_size: [64, 64]  # í…ŒìŠ¤íŠ¸ìš© ìž‘ì€ í¬ê¸°
          batch_size: 4

        model:
          input_shape: [64, 64, 1]
          num_classes: 9
          learning_rate: 0.01
          early_stopping_patience: 2
          reduce_lr_patience: 1

        training:
          checkpoint_dir: \"test_checkpoints\"
          save_best_only: true

        classes:
          - \"Center\"
          - \"Donut\"
          - \"Edge-Loc\"
          - \"Edge-Ring\"
          - \"Loc\"
          - \"Near-full\"
          - \"None\"
          - \"Random\"
          - \"Scratch\"
            ''')

        # ë¯¸ë‹ˆ ë°ì´í„°ì…‹ ìƒì„±
        from data.data_manager import DataManager
        dm = DataManager()
        print('ðŸ“Š ë¯¸ë‹ˆ ë°ì´í„°ì…‹ ìƒì„± ì¤‘...')
        dm.create_sample_dataset(samples_per_class=2)  # í´ëž˜ìŠ¤ë‹¹ 2ê°œ

        # ëª¨ë¸ ë¹Œë“œ ë° êµ¬ì¡° í™•ì¸
        from models.cnn_model import DefectDetectionCNN
        cnn = DefectDetectionCNN()
        model = cnn.build_model()
        print(f'âœ… í†µí•© í…ŒìŠ¤íŠ¸ ì„±ê³µ! ëª¨ë¸ íŒŒë¼ë¯¸í„°: {model.count_params():,}')
        "

  security-check:
    name: ë³´ì•ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: ì €ìž¥ì†Œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4

    - name: Python í™˜ê²½ ì„¤ì •
      uses: actions/setup-python@v4
      with:
        python-version: ${{ env.PYTHON_VERSION }}

    - name: Safety ë³´ì•ˆ ê²€ì‚¬ ì„¤ì¹˜
      run: |
        pip install safety bandit

    - name: ì˜ì¡´ì„± ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: |
        pip install -r requirements.txt
        safety check

    - name: ì½”ë“œ ë³´ì•ˆ ì·¨ì•½ì  ê²€ì‚¬
      run: |
        bandit -r src -f json -o bandit-report.json || true
        bandit -r src

  notify:
    name: ì•Œë¦¼
    runs-on: ubuntu-latest
    needs: [lint-and-format, test, model-test]
    if: always()

    steps:
    - name: ê²°ê³¼ ìš”ì•½
      run: |
        echo "ðŸš€ CI íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ì™„ë£Œ"
        echo "ðŸ“Š ê²°ê³¼ ìš”ì•½:"
        echo "  - ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬: ${{ needs.lint-and-format.result }}"
        echo "  - ë‹¨ìœ„ í…ŒìŠ¤íŠ¸: ${{ needs.test.result }}"
        echo "  - ëª¨ë¸ í…ŒìŠ¤íŠ¸: ${{ needs.model-test.result }}"

        if [[ "${{ needs.lint-and-format.result }}" == "success" && "${{ needs.test.result }}" == "success" && "${{ needs.model-test.result }}" == "success" ]]; then
          echo "âœ… ëª¨ë“  ê²€ì‚¬ í†µê³¼! ë¨¸ì§€ ì¤€ë¹„ ì™„ë£Œ"
        else
          echo "âŒ ì¼ë¶€ ê²€ì‚¬ ì‹¤íŒ¨. ìˆ˜ì • í›„ ë‹¤ì‹œ ì‹¤í–‰í•´ì£¼ì„¸ìš”."
        fi
